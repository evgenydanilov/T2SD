<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="T2SD : Sample sequence diagrams">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>T2SD</title>

  </head>

  <body>

    <script src="./javascripts/lib/raphael.min.js"></script>
    <script src="./javascripts/lib/underscore-min.js"></script>
    <script src="./javascripts/lib/sequence-diagram-min.js"></script>
    <script src="./javascripts/lib/src-min-noconflict/ace.js"></script>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <!--a id="forkme_banner" href="https://github.com/evgenydanilov/T2SD">View on GitHub</a-->

          <h1 id="project_title">T2SD</h1>
          <h2 id="project_tagline">Sample sequence diagrams</h2>

            <!--section id="downloads">
              <a class="zip_download_link" id="download_link" href="#">Download as PNG</a>
            </section-->
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">

        <table width="100%">
          <tr>
              <td width =40% valign="top" align="left">
                 <div id="editor">participant Alice as A
participant Man In The Middle as M
participant Bob as B

A->M: Original Challenge
M->B: Fake Challenge
M-->A: Fake Response
B-->M: Response</div>
                 Theme:
                 <select id="theme_id">
                   <option value="simple">Simple</option>
                   <option value="hand">Hand drawn</option>
                   <option value="custom" selected>Custom</option>
                 </select>
	         <a id="download_link" href="#">Download as PNG</a>
              </td>

              <td width =60% valign="top" align="left">  
                 <div id="diagram-body"></div>
              </td>
          	
          </tr>
        </table>
	<canvas id="canvas" width="1000px" height="600px"></canvas> 
      </section>
    </div>

<script>

  // ace.require("ace/ext/language_tools");
  var editor = ace.edit("editor");

  editor.session.setMode("ace/mode/text");
  editor.setTheme("ace/theme/tomorrow");
  
  //editor.setOptions({
  //    enableBasicAutocompletion: true
  //});

  var theme_sel = document.getElementById('theme_id'); 
  var diagram_div = document.getElementById('diagram-body');  
  var download_link = document.getElementById('download_link');

  var on_change = function() {

    editor.session.clearAnnotations();

    try {
      var diagram = Diagram.parse(editor.getValue());
      diagram_div.innerHTML = '';

      diagram.drawSVG("diagram-body", {theme: theme_sel.value});


      var svg_data = diagram_div.innerHTML;

      var canvas = document.getElementById("canvas");
      var context = canvas.getContext("2d");

      var DOMURL = window.URL || window.webkitURL || window;

      var img = new Image();
      var svg = new Blob([svg_data], {type: 'image/svg+xml;charset=utf-8'});
      var url = DOMURL.createObjectURL(svg);

      img.src = url;
      
      img.onload = function()
      {
        
        context.drawImage(img, 0, 0);

        DOMURL.revokeObjectURL(url);
            
        download_link.download = "diagram.png"; // TODO I could put title here
        download_link.href = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream"); 

        context.clearRect(0, 0, canvas.width, canvas.height);
      }

    }
    catch (e) 
    {
      var annotation = {
        type: "error", // also warning and information
        column: 0,
        row: 0,
        text: e.message
      };

      var regexp = /Parse error on line (\d+):/;
      var found = regexp.exec(e.message);

      if (found && found.length == 2)
      {
        annotation.row = found[1] - 1;
      }

      editor.session.setAnnotations([annotation]);
    }
  };

  editor.getSession().on('change', _.debounce(on_change, 100));
  
  theme_sel.onchange = on_change;
  window.onload = on_change;

</script>

  </body>
</html>
